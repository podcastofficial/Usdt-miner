<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USDT Miner</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #0f172a; color: white; }
        .container { max-width: 500px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #3b82f6, #1d4ed8); padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 20px; }
        .balance { font-size: 2.5rem; font-weight: bold; margin: 10px 0; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
        .btn { background: #3b82f6; color: white; border: none; padding: 15px; border-radius: 10px; cursor: pointer; font-size: 16px; }
        .btn:hover { background: #2563eb; }
        .package { background: #1e293b; padding: 15px; border-radius: 10px; margin: 10px 0; border: 2px solid #334155; }
        .package:hover { border-color: #3b82f6; }
        .screen { display: none; }
        .screen.active { display: block; }
        .back-btn { background: none; border: none; color: white; font-size: 1.5rem; margin-bottom: 20px; cursor: pointer; }
        input { width: 100%; padding: 12px; margin: 10px 0; background: #0f172a; border: 1px solid #334155; border-radius: 8px; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading -->
        <div id="loading" class="screen active">
            <h2>Loading USDT Miner...</h2>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="screen">
            <div class="header">
                <h2 id="user-name">User</h2>
                <div class="balance">$<span id="balance">0.00</span></div>
                <p>Available Balance</p>
            </div>
            
            <div class="btn-group">
                <button class="btn" onclick="showScreen('invest')">üíé Invest</button>
                <button class="btn" onclick="showScreen('withdraw')">üì§ Withdraw</button>
                <button class="btn" onclick="showScreen('referral')">üë• Referral</button>
                <button class="btn" onclick="loadStats()">üìä Stats</button>
            </div>
            
            <div id="package-info" class="package">
                <h3>Current Package</h3>
                <p id="current-package">None</p>
            </div>
            
            <h3>Recent Transactions</h3>
            <div id="transactions"></div>
        </div>

        <!-- Invest Screen -->
        <div id="invest" class="screen">
            <button class="back-btn" onclick="showScreen('dashboard')">‚Üê Back</button>
            <h2>Select Package</h2>
            
            <div class="package" onclick="selectPackage('basic')">
                <h3>Basic - $10</h3>
                <p>Daily ROI: $0.10</p>
                <p>Total ROI: $25</p>
                <button class="btn">Select</button>
            </div>
            
            <div class="package" onclick="selectPackage('silver')">
                <h3>Silver - $25</h3>
                <p>Daily ROI: $0.25</p>
                <p>Total ROI: $62.5</p>
                <button class="btn">Select</button>
            </div>
            
            <div class="package" onclick="selectPackage('gold')">
                <h3>Gold - $100</h3>
                <p>Daily ROI: $1.00</p>
                <p>Total ROI: $250</p>
                <button class="btn">Select</button>
            </div>
        </div>

        <!-- Withdraw Screen -->
        <div id="withdraw" class="screen">
            <button class="back-btn" onclick="showScreen('dashboard')">‚Üê Back</button>
            <h2>Withdraw USDT</h2>
            
            <p>Available: $<span id="available-balance">0.00</span></p>
            <input type="number" id="amount" placeholder="Amount" min="1">
            <input type="text" id="wallet" placeholder="USDT TRC20 Address">
            <button class="btn" onclick="withdraw()">Withdraw Now</button>
            <p style="margin-top: 10px; color: #94a3b8;">Processing: 1-24 hours</p>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        let userData = null;
        
        async function initApp() {
            tg.expand();
            tg.ready();
            
            // Get Telegram user
            const user = tg.initDataUnsafe?.user;
            if (!user) {
                alert('Please open from Telegram');
                return;
            }
            
            // Register user
            const response = await fetch('/api/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    telegramId: user.id,
                    username: user.username,
                    firstName: user.first_name,
                    lastName: user.last_name
                })
            });
            
            userData = await response.json();
            loadDashboard();
            showScreen('dashboard');
        }
        
        async function loadDashboard() {
            const response = await fetch(`/api/dashboard/${userData.user.telegramId}`);
            const data = await response.json();
            
            // Update UI
            document.getElementById('user-name').textContent = 
                userData.user.firstName || userData.user.username || 'User';
            document.getElementById('balance').textContent = 
                data.user.earnings.availableBalance.toFixed(2);
            document.getElementById('available-balance').textContent = 
                data.user.earnings.availableBalance.toFixed(2);
            
            // Package info
            const packageInfo = document.getElementById('current-package');
            if (data.user.package.name) {
                packageInfo.innerHTML = `
                    <strong>${data.user.package.name.toUpperCase()}</strong><br>
                    Investment: $${data.user.package.amount}<br>
                    Daily ROI: $${data.user.package.dailyROI}
                `;
            } else {
                packageInfo.textContent = 'No active package';
            }
            
            // Transactions
            const txContainer = document.getElementById('transactions');
            if (data.transactions.length > 0) {
                txContainer.innerHTML = data.transactions.map(tx => `
                    <div style="background:#1e293b; padding:10px; margin:5px 0; border-radius:8px;">
                        <div style="display:flex; justify-content:space-between;">
                            <span>${tx.type}</span>
                            <span style="color:${tx.amount > 0 ? '#10b981' : '#ef4444'}">
                                ${tx.amount > 0 ? '+' : '-'}$${Math.abs(tx.amount)}
                            </span>
                        </div>
                        <small style="color:#94a3b8;">${new Date(tx.timestamp).toLocaleDateString()}</small>
                    </div>
                `).join('');
            } else {
                txContainer.innerHTML = '<p style="color:#94a3b8; text-align:center;">No transactions yet</p>';
            }
        }
        
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }
        
        async function selectPackage(packageType) {
            if (!confirm(`Invest in ${packageType.toUpperCase()} package?`)) return;
            
            const response = await fetch('/api/invest', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    telegramId: userData.user.telegramId,
                    packageType: packageType
                })
            });
            
            const result = await response.json();
            alert(result.success ? 'Investment successful!' : result.error);
            loadDashboard();
            showScreen('dashboard');
        }
        
        async function withdraw() {
            const amount = document.getElementById('amount').value;
            const wallet = document.getElementById('wallet').value;
            
            if (!amount || !wallet) {
                alert('Please fill all fields');
                return;
            }
            
            const response = await fetch('/api/withdraw', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    telegramId: userData.user.telegramId,
                    amount: amount,
                    walletAddress: wallet
                })
            });
            
            const result = await response.json();
            alert(result.success ? 'Withdrawal submitted!' : result.error);
            
            // Clear form
            document.getElementById('amount').value = '';
            document.getElementById('wallet').value = '';
            
            loadDashboard();
            showScreen('dashboard');
        }
        
        async function loadStats() {
            const response = await fetch(`/api/dashboard/${userData.user.telegramId}`);
            const data = await response.json();
            
            alert(`Total ROI: $${data.user.earnings.totalROI.toFixed(2)}\nReferral Earnings: $${data.user.earnings.totalReferral.toFixed(2)}`);
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
